<!doctype html>
<html lang="us">
<head>
	<meta charset="utf-8">
	<title>An abandoned tower</title>
	<link href="jquery-ui.css" rel="stylesheet">
	<style>
	body{
		font: "Trebuchet MS", sans-serif;
		margin-left: 50px;
		margin-top: 50px;
	}
	.demoHeaders {
		margin-top: 2em;
	}
	.fakewindowcontain .ui-widget-overlay {
		position: absolute;
	}
	select {
		width: 200px;
	}
	#dialog {
		width: 30em;
		text-align: justify;
		height: 35em;
		overflow: hidden;
	}
	div#notifyGradient {
	position: absolute;
	top: 15em;
	left: 0px;
	height: 24;
	width: 100%;
	background-color: white;
	background: -webkit-linear-gradient(
		rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 1) 100%
	);
	background: linear-gradient(
		rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 1) 100%
	);
	filter: alpha(
		Opacity=0, FinishOpacity=100, Style=1, StartX=0, StartY=0, FinishX=0, FinishY=500
	);
	}
	.positioned {
		display: table-cell;
		padding-right: 3em;
	}
	#controls {
		vertical-align: top;
	}
	.ui-buttonset {
		margin-right:5px;
	}
	label {
		width: -moz-available;
	}	
	h2 {
		font-family: helvetica;
	}
	.day-counter {
		font-weight: bold;
	}
	#reset {
		position: absolute;
		right: 0px;
		bottom: 0px;
	}
	</style>
	<script>
		var game = {};
		function init() {
			_.id = _.identity;
			game.buttonAction = "firstDay";
			hide("#storage");
			hide("#progress");
			$(".hidden").hide();
			var aux = function () {
				eval(game.buttonAction)();
			};
			$("#button").button().click(aux);
			$(document).bind('keyup', 'return', aux);
			$(document).bind('keyup', 'F4', resetSave);
			$("#reset").button().click(resetSave);
			hide("#accordion").accordion();
			$("#accordion > div").css({
				"height" : "auto",
				"padding" : "0px"
			});
			_.each(["morning", "afternoon", "evening", "night"], genRadioSet);
			unpressButtons();
			$("form").css({margin:"0px"});
			game.dayTime = true;
			game.disabledDayTime = null;
			game.storage = {};
			game.triggers = [];
			game.day = 1;
			game.tasks = {};
			game.afterToggle = ["_.id", null];
			game.activities = {};
			game.activity = {
				"morning" : null,
				"afternoon" : null,
				"evening" : null,
				"night" : null
			};
			restoreSave();
			game.radios = [];
			setActivities();
			setTriggers();
		}


		function restoreSave() {
			game = getLocalStorage("game", game);
			if(_.size(game.storage) > 0) {
				toggleDayTime();
				eval(game.afterToggle[0])(game.afterToggle[1]);
				if(game.dayTime) startNewDay();
				fadeIn("#storage");
				$("#dialog").empty();
				$("#button").hide();
				setTriggers();
				game.dayTime = !game.dayTime;
				triggerEvents();
				game.dayTime = !game.dayTime;
				disableDayTime();
			}
			if(_.size(game.tasks) > 0) {
				fadeIn("#progress");
				if(game.patchedRoof) {
					$("#roof").parent().hide();
				}
			}
		}

		function setActivities() {
			_.each(game.activities, function (attr, text) {
				addActivity(text, attr[0], attr[1]);
			});
		}

		function resetSave() {
			setLocalStorage("game", null);
			document.location.reload();
		}

		function trigger(condition, action) {
			this.condition = condition;
			this.action = action;
		}

		function firstDay() {
			$("#button").fadeOut(400, startDay);
			game.buttonAction = "_.id";
		}
	
		function startDay() {
			triggerEvents();
			toggleDayTime();
		}

		function searchFood() {
			changeStorageBy("food", 2);
			appendMessage("#findFood");
		}
		
		function collectWood() {
			changeStorageBy("wood", 3);
			appendMessage("#collectWood");
		}

		function changeStorageBy(item, amount) {
			game.storage[item] = amount + (game.storage[item] | 0);
			game.storage[item] = (game.storage[item] > 0) ? game.storage[item] : 0; 
		}

		function updateGame() {
			if(_.size(_.filter(game.activity, function (v) {
				return v != null;
				})) != 2) {
				return;
			}
			fadeOut("#accordion", function () {
				commitActions();
				enableDayTime();
				setLocalStorage("game", game);
				triggerEvents();
				game.radios = [];
				toggleDayTime();
				disableDayTime();
				if(game.dayTime) startNewDay();
			});
		}

		function triggerEvents() {
			_.each(game.triggers, function (t) {
				if(t.condition()) t.action();
			});
		}

		function unpressButtons(){
			$(".ui-state-active").removeClass("ui-state-active");
		}

		function startNewDay() {
			game.day++;
			unpressButtons();
		}

		function commitActions() {
			_.each(game.activity, function (f, t) {
				if(f != null) eval(f)();
				game.activity[t] = null;
			});
		}

		function fixRoof() {
			show("#progress");
			game.tasks.roof = 20 + (game.tasks.roof | 0);
			changeStorageBy("wood", -1);
			$("#roof").html(game.tasks.roof + "%");
		}

		function addActivity(text, action, time) {
			var i = _.size(game.radios);
			_.each(time, function (t) {
				var radio = $("#radio" + t + i);
				radio.button({label: text}).click({
					time:t,
					action:action},
					selectActivity);
				radio.parent().show();
			});
			game.radios.push(action);
			game.activities[text] = [action, time];
		}

		function removeActivity(text) {
			$(":radio").map(function (i, v) {
				var b = $(v)
				if(b.button('option', 'label') == text) {
					b.button("option", "label", "");
					b.parent().hide();
					b.click(_.id);
				}
			});
			game.activities[text] = undefined;
		}

		function selectActivity(ev) {
			game.activity[ev.data.time] = ev.data.action;
			updateGame();
		}
		function genRadioSet(time) {
			$("#" + time).append("<form><div id='radioset" + time + "'>");
			_.each(_.range(5), function (v) {
				var container = $("<div>");
				$("#radioset" + time).append(container)
				container.append("<input type='radio' id='radio" + time + v + "' name='radio'" + time + "'>")
				container.append("<label for='radio" + time + v + "'>");
			});
			$("#radioset" + time).buttonset();
			$("#radioset" + time + " > div").hide();
		}
		function appendMessage(id) {
			$("#dialog").prepend($(id).clone());
			$(id).fadeIn();
		}

		function toggleDayTime() {
			if(game.dayTime){
				$(".morning,.afternoon").show();
				$(".evening,.night").hide();
				game.activity["morning"] = null;
				game.activity["afternoon"] = null;
			}
			else {
				$(".morning,.afternoon").hide();
				$(".evening,.night").show();
				game.activity["evening"] = null;
				game.activity["night"] = null;
			}
			game.dayTime = ! game.dayTime;
			fadeIn("#accordion");
			updateStorage();
		}

		function updateStorage() {
			$("#wood").html(game.storage.wood);
			$("#food").html(game.storage.food);
		}

		function enableDayTime() {
			if(game.disabledDayTime != null) {
				$("#radioset" + game.disabledDayTime).buttonset({disabled:false})
				game.disabledDayTime = null;
			}
		}

		function disableDayTime() {
			if(game.disabledDayTime != null) {
				$("#radioset" + game.disabledDayTime).buttonset({disabled:true})
				game.activity[game.disabledDayTime] = "_.id";
			}
		}

		function setTriggers() {
			game.triggers = [
				new trigger(
					function () {
						return game.dayTime;
					}, function () {
						appendMessage("<div class='day-counter'>Day: " + game.day + "</div><hr/>");
					}
				), new trigger(
					function () {
						return game.day == 1 && game.dayTime == false;
					}, function () {
						appendMessage("#day1evening");
					}
				), new trigger(
					function () {
						return game.day == 1 && game.dayTime == true;
					}, function () {
						appendMessage("#day1morning");
						addActivity("Find food", "searchFood", ["morning", "afternoon"]);
						addActivity("Collect wood", "collectWood", ["morning", "afternoon"]);
						addActivity("Sleep", "_.id", ["evening", "night"]);
						fadeIn("#storage");
					}
				), new trigger(
					function () {
						return game.day > 1 && game.dayTime == true;
					}, function () {
						if(game.storage.food > 0) {
							changeStorageBy("food", -1);
							appendMessage("#eatBreakfast");
						}
						else {
							appendMessage("#starving");
							game.disabledDayTime = "morning";
						}
					}
				), new trigger(
					function () {
						return game.day > 2 && _.random(0, 100) < 10 && (!game.patchedRoof);
					}, function () {
						var wood = _.random(1, 3);
						var food = _.random(1, 3);
						changeStorageBy("wood", -wood);
						changeStorageBy("food", -food);
						appendMessage("<div>" + wood + " wood and " + food + " food units were washed away by the rain.</div>");
						appendMessage("#rain");
					}
				), new trigger(
					function () {
						return game.tasks.roof == 100 && (! game.patchedRoof);
					}, function () {
						appendMessage("#fixRoofComplete");
						game.patchedRoof = true;
						removeActivity("Fix roof");
						$("#roof").parent().fadeOut();
						appendMessage("#gameOver");
					}
				), new trigger(
					function () {
						return game.day > 0 && game.dayTime == false;
					}, function () {
						if(game.storage.wood > 0) {
							changeStorageBy("wood", -1);
							appendMessage("#campfire");
						}
						else {
							appendMessage("#freezing");
							game.disabledDayTime = "evening";
						}
					}
				), new trigger(
					function () {
						return game.storage.wood > 5 && game.tasks.roof == undefined;
					}, function () {
						appendMessage("#fixRoof1");
						addActivity("Fix roof", "fixRoof", ["evening"]);
						fadeIn("#progress");
						game.tasks.roof = 0;
					}
				)];
		}

		/*Fade with no display:none*/
		function fadeIn(id, fun) {
			return $(id).fadeTo("normal", 1, fun);
		}
		function fadeOut(id, fun) {
			return $(id).fadeTo("normal", 0, fun);
		}
		function show(id) {
			return $(id).fadeTo(0, 1);
		}
		function hide(id) {
			return $(id).fadeTo(0, 0);
		}
		function getLocalStorage(item, default_) {
			var value = JSON.parse(localStorage.getItem(item));
			if(value == null) {
				return default_;
		    }
		    else {
		        return value;
		    }
		}

		function setLocalStorage(item, value) {
		    localStorage.setItem(item, JSON.stringify(value));
		}
	</script>
</head>
<body>

<button id="reset">Reset save</button>

<div class="positioned">
	<div id="dialog">
	<p>It's the middle of the night, while searching for shelter you come by an abandoned tower.</p>
	<p>Its celing have collapsed, the walls are damp and moldy and the floor is full of debris.
	This place must have been abandoned for at least a 5 years.</p>
	<p>You decide to spend your night in it, what do you do now?</p>
	</div>
	<div id="notifyGradient"></div>
</div>


<div id="controls" class="positioned">
	<div id="accordion">
		<h3 class="morning">Morning</h3>
		<div id="morning" class="morning">
		</div>
		<h3 class="afternoon">Afternoon</h3>
		<div id="afternoon" class="afternoon">
		</div>
		<h3 class="evening">Evening</h3>
		<div id="evening" class="evening">
		</div>
		<h3 class="night">Night</h3>
		<div id="night" class="night">
		</div>
	</div>
	<button id="button">Sleep</button>
</div>

<div id="progress" class="positioned">
	<h2>Task progress</h2>
	<ul>
		<li>Fix roof: <span id="roof">0%</span></li>
	</ul>
</div>

<div id="storage" class="positioned">
	<h2>Storage</h2>
	<table>
		<tr><td>Food:</td><td id="food">0</td></tr>
		<tr><td>Wood:</td><td id="wood">0</td></tr>
	</table>
</div>

<div id="day1morning" class="hidden">
	<p>You wake up early in the morning, eat your breakfast and realize that you are low on
supplies.
	</p>
	<p>It's time for you to plan your activities during the day and evening.</p>
	<p>For now, you need food and fire wood.</p>
</div>

<div id="day1evening" class="hidden">
	<p>The sun have just set, it's no longer safe to walk in the woods.</p>
</div>

<div id="fixRoof1" class="hidden">
	<p>You notice that the branches and twigs you have accumulated could be used to patch up the roof.
While that solution isn't ideal, that should be able to protect you from the weather most of the
time.</p>
</div>

<div id="campfire" class="hidden">
	<p>You light up the campfire.</p>
</div>

<div id="eatBreakfast" class="hidden">
	<p>	You eat your breakfast.</p>
</div>

<div id="starving" class="hidden">
	<p>You are starving, so you spend your morning desperatedly looking for food.</p>
</div>

<div id="freezing" class="hidden">
	<p>The night cold is unbearable so you spend the evening gathering firewood.</p>
</div>

<div id="rain" class="hidden"><p>A cold rain started pouring from the skies.</p></div>

<div id="fixRoofComplete" class="hidden"><p>You patched the roof, now the light rain shouldn't bother you anymore.</p></div>

<div id="findFood" class="hidden"><p>You manage to collect some edible roots and berries.</p></div>

<div id="collectWood" class="hidden"><p>You gather sticks and branches from the forest floor.</p></div>

<div id="gameOver" class="hidden">
	<h1>You have seen the last event of the game. More stuff will be added in the next update.</h1>
</div>

<script src="external/jquery/jquery.js"></script>
<script src="jquery-ui.js"></script>
<script src="external/underscore.js"></script>
<script src="external/jquery.hotkeys.js"></script>
<script>
	init();
</script>
</body>
</html>
